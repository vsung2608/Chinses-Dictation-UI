<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            <div class="main-container">
                <!-- Header Section -->
                <div class="header-section">
                    <h1 class="header-title">Luy·ªán Ch√©p Ch√≠nh T·∫£</h1>
                    <p class="header-subtitle">Nghe v√† vi·∫øt ch√≠nh x√°c nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c</p>
                    <div class="lesson-info">
                        <div class="info-item">
                            <span class="info-number">{{ lesson?.displayOrder }}</span>
                            <span class="info-label">B√†i h·ªçc</span>
                        </div>
                        <div class="info-item">
                            <span class="info-number">{{ lesson?.level }}</span>
                            <span class="info-label">C·∫•p ƒë·ªô</span>
                        </div>
                        <div class="info-item">
                            <span class="info-number">{{ lesson?.estimatedDurationSeconds }}</span>
                            <span class="info-label">Th·ªùi l∆∞·ª£ng</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="audio-section col-12 col-xl-6">
                        <div class="audio-player">
                            <audio #audioPlayer [src]="lesson?.audioFilePath"></audio>

                            <h3 class="audio-title">
                                <i class="fas fa-headphones me-2"></i>
                                {{lesson?.titleChinese}} / {{lesson?.titleVietnamese}}
                            </h3>

                            <div class="audio-controls">
                                <button class="play-button" (click)="playAudioSegment()">
                                    <i class="fas" [ngClass]="isPlaying ? 'fa-pause' : 'fa-play'"></i>
                                </button>

                                <div class="speed-control">
                                    <span class="me-2">T·ªëc ƒë·ªô:</span>
                                    <div class="speed-buttons-container">
                                        <div class="speed-buttons-wrapper" [style.transform]="getSliderPosition()">
                                            <button *ngFor="let s of speeds; let i = index" class="speed-btn"
                                                [class.active]="s === currentSpeed" (click)="setSpeed(s)">
                                                {{ s }}x
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="progress-container">
                                <div class="progress-bar-custom">
                                    <div class="progress-fill" [style.width.%]="progress"></div>
                                </div>
                                <div class="time-display">
                                    <span>{{ formatTime(currentTime) }}</span>
                                    <span>{{ formatTime(duration) }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="error-notification text-center fw-bold" *ngIf="isIncorrect && currentSentence">
                            <span class="celebration-icon">Kh√¥ng ch√≠nh x√°c: </span>
                            <span class="error-text" [innerHTML]="higlightIncorrectAnswer()"></span>
                        </div>

                        <div class="success-notification text-center fw-bold" *ngIf="isCorrect && currentSentence">
                            <span class="celebration-icon">üéâ</span>
                            <span class="success-text">B·∫°n ƒë√£ vi·∫øt ƒë√∫ng!</span>
                            <span class="celebration-icon">üéâ</span>
                        </div>

                        <div class="answer-display mt-3" *ngIf="isCorrect && currentSentence">
                            <div class="chinese-text">
                                <span class="label">H√°n t·ª±: </span>
                                <span class="content" *ngIf="currentSentence">{{currentSentence.chineseText}}</span>
                            </div>
                            <div class="pinyin-text">
                                <span class="label">Pinyin: </span>
                                <span class="content" *ngIf="currentSentence">{{currentSentence.pinyinText}}</span>
                            </div>
                            <div class="vietnamese-text">
                                <span class="label">Nghƒ©a: </span>
                                <span class="content"
                                    *ngIf="currentSentence">{{currentSentence.vietnameseTranslation}}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Dictation Section -->
                    <div class="dictation-section col-12 col-xl-6">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-content-center">
                                <label for="dictationInput" class="form-label fw-semibold">
                                    <i class="fas fa-pen me-2"></i>
                                    Vi·∫øt nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c (C√¢u s·ªë {{currentSentenceIndex + 1}}/
                                    {{lesson?.totalSentences}})
                                </label>
                                <div class="btn-report fw-bold" (click)="visibleReportDialog = true">
                                    B√°o c√°o <i class="fa-solid fa-flag"></i>
                                </div>
                            </div>

                            <textarea class="dictation-input" id="dictationInput" [(ngModel)]="userAnswer"
                                placeholder="B·∫Øt ƒë·∫ßu nh·∫≠p vƒÉn b·∫£n t·∫°i ƒë√¢y..." (focus)="focusInput()"></textarea>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-custom btn-primary-custom" (click)="checkAnswer()"
                                [disabled]="!userAnswer.trim()">
                                <i class="fas fa-check me-2"></i>
                                Ki·ªÉm tra
                            </button>
                            <button class="btn btn-next ms-2" (click)="nextExercise()" *ngIf="showResult">
                                <i class="fas fa-arrow-right me-2"></i>
                                C√¢u ti·∫øp theo
                            </button>
                            <button class="btn btn-skip btn-custom ms-2" (click)="skipExercise()" *ngIf="!showResult">
                                <i class="fas fa-arrow-right me-2"></i>
                                B·ªè qua
                            </button>
                        </div>

                        <div class="card">
                            <p-tabs value="0" scrollable>
                                <p-tablist>
                                    <ng-template #previcon>
                                        <i class="pi pi-minus"></i>
                                    </ng-template>
                                    <p-tab value="0">
                                        <span class="font-bold whitespace-nowrap">M√¥ t·∫£ b√†i h·ªçc</span>
                                    </p-tab>
                                    <p-tab value="1">
                                        <span class="font-bold whitespace-nowrap">N·ªôi dung b√†i nghe</span>
                                    </p-tab>
                                    <p-tab value="2">
                                        <span class="font-bold whitespace-nowrap">B√¨nh lu·∫≠n</span>
                                        <p-badge value="2" styleClass="main-color" />
                                    </p-tab>
                                    <ng-template #nexticon>
                                        <i class="pi pi-plus"></i>
                                    </ng-template>
                                </p-tablist>
                                <p-tabpanels>
                                    <p-tabpanel value="0">
                                        <div class="instruction">
                                            <h5>
                                                <i class="fas fa-info-circle me-2"></i>
                                                H∆∞·ªõng d·∫´n
                                            </h5>
                                            <p class="mb-0">
                                                Nghe audio v√† vi·∫øt l·∫°i ch√≠nh x√°c nh·ªØng g√¨ b·∫°n nghe ƒë∆∞·ª£c. B·∫°n
                                                c√≥ th·ªÉ nghe l·∫°i
                                                nhi·ªÅu l·∫ßn v√† s·ª≠ d·ª•ng c√°c c√¥ng c·ª• h·ªó tr·ª£ b√™n tr√™n.</p>
                                        </div>
                                        <p class="m-0">
                                            Lorem ipsum dolor sit, amet consectetur adipisicing elit. Voluptatibus,
                                            suscipit. Ipsum exercitationem quod rerum nisi dolor provident nostrum
                                            quidem! Impedit rem in amet, dolorem asperiores cupiditate facere? Natus,
                                            iste veniam!
                                        </p>
                                    </p-tabpanel>
                                    <p-tabpanel value="1">
                                        <section class="lesson-content">
                                            @for(sentence of lesson?.sentences; track sentence.id){
                                            <div class="mb-4">
                                                <div class="fw-bold">{{ sentence.sentenceOrder }}. {{
                                                    sentence.chineseText }}</div>
                                                <div>{{ sentence.pinyinText }}</div>
                                            </div>
                                            }
                                        </section>
                                    </p-tabpanel>
                                    <p-tabpanel value="2">
                                        <section class="comment-section" *ngIf="comments$ | async as comments">
                                            @for (comment of comments; track comment.id){
                                            <div class="comment mb-2 mb-3" *ngIf="replies$ | async as replies">
                                                <div class="avatar-line-vertical" *ngIf="comment.replyCount > 0"></div>
                                                <div class="d-flex mb-2">
                                                    <div class="avatar-wrapper position-relative me-2">
                                                        <div class="avatar">
                                                            <img [src]="comment.userAvatarUrl" alt="avatar"
                                                                class="rounded-circle" width="40" height="40" />
                                                        </div>
                                                        <div class="avatar-line"></div>
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold"><a class="text-dark me-2">
                                                                {{comment.userName}} </a> <a class="reply"
                                                                (click)="reply(comment.id, comment.userName)"><i
                                                                    class="bi bi-reply-fill"></i> Tr·∫£ l·ªùi </a></div>
                                                        <div class="content">
                                                            {{comment.content}}
                                                        </div>
                                                        <div [style]="'font-size: 12px'">
                                                            <span class="fw-bold me-4"> {{comment.createdAt}} </span>
                                                            <span class="fw-bold">11 like</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="fw-bold ms-5 mb-2" (click)="toggleReplies(comment.id)"
                                                    [style]="'cursor: pointer'" *ngIf="comment.replyCount > 0">
                                                    {{ expandedComments[comment.id] ? '·∫®n b·ªõt b√¨nh lu·∫≠n' : 'Xem th√™m ' +
                                                    comment.replyCount + ' b√¨nh lu·∫≠n' }}
                                                </div>
                                                <div *ngIf="expandedComments[comment.id]">
                                                    @for (reply of replies; track reply.id){
                                                    @if(reply.parentCommentId === comment.id){
                                                    <div class="child-comment ms-5 mb-2">
                                                        <div class="dot-on-line"></div>
                                                        <div class="d-flex mb-2">
                                                            <div class="avatar-wrapper position-relative me-2">
                                                                <div class="avatar">
                                                                    <span class="circle-dot"></span>
                                                                    <img [src]="reply.userAvatarUrl" alt="avatar"
                                                                        class="rounded-circle" width="40" height="40" />
                                                                </div>
                                                                <div class="avatar-line"></div>
                                                            </div>
                                                            <div>
                                                                <div class="fw-bold"><a href=""
                                                                        class="text-dark me-2">{{reply.userName}}</a> <a
                                                                        href="#" class="reply"><i
                                                                            class="bi bi-reply-fill"></i> Reply</a>
                                                                </div>
                                                                <div class="content">{{reply.content}}</div>
                                                                <div [style]="'font-size: 12px'">
                                                                    <span
                                                                        class="fw-bold me-4">{{reply.createdAt}}</span>
                                                                    <span class="fw-bold me-4">11 like</span>
                                                                    @if(comment.userId === '1'){
                                                                    <span class="fw-bold me-4">X√≥a b√¨nh lu·∫≠n</span>
                                                                    <span class="fw-bold me-4">S·ª≠a b√¨nh lu·∫≠n</span>
                                                                    }@else{
                                                                    <span class="fw-bold me-4">B√°o c√°o b√¨nh lu·∫≠n</span>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    }
                                                    }
                                                </div>
                                            </div>
                                            }
                                        </section>
                                        <div class="comment-form">
                                            <input #replyInput placeholder="Nh·∫≠p b√¨nh lu·∫≠n ·ªü ƒë√¢y"
                                                [(ngModel)]="commentContent" (keydown)="handleKeyDown($event)">
                                            <button type="button" (click)="postComment()">Gui</button>
                                        </div>
                                    </p-tabpanel>
                                </p-tabpanels>
                            </p-tabs>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<p-dialog  [(visible)]="visibleReportDialog" [modal]="true" [style]="{ width: '25rem' }">
    <ng-template #header>
        <div class="d-flex align-items-center gap-2">
            <p-avatar image="https://primefaces.org/cdn/primeng/images/demo/avatar/amyelsner.png" shape="circle" />
            <span class="fw-bold whitespace-nowrap">Amy Elsner</span>
        </div>
    </ng-template>
    <span class="text-surface-500 dark:text-surface-400 block mb-8">B√°o c√°o l·ªói v·ªÅ c√¢u trong b√†i</span>
    <p-floatlabel variant="on" class="input">
        <input pInputText id="title" [(ngModel)]="titleReport" style="width: 100%;" name="title"/>
        <label for="title">Ti√™u ƒë·ªÅ</label>
    </p-floatlabel>
    <p-floatlabel variant="on" class="input">
        <textarea pTextarea id="reason" autocomplete="off" [(ngModel)]="reasonReport" style="width: 100%; height: 100px;" ></textarea>
        <label for="reason">N·ªôi dung</label>
    </p-floatlabel>

    <ng-template #footer>
        <p-button label="H·ªßy" [text]="true" severity="secondary" (click)="visibleReportDialog = false" />
        <p-button label="G·ª≠i" [outlined]="true" severity="secondary" (click)="visibleReportDialog = false" />
    </ng-template>
</p-dialog>